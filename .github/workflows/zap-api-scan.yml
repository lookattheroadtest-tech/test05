name: zap-api-scan

on:
  workflow_dispatch:

jobs:
  zap-scan:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Pull ZAP image
      run: docker pull ghcr.io/zaproxy/zaproxy:stable

    - name: Start ZAP daemon
      run: |
        docker run -d --name zap \
          -u zap \
          -p 8080:8080 \
          -v $(pwd):/zap/wrk \
          ghcr.io/zaproxy/zaproxy:stable \
          zap.sh -daemon -host 0.0.0.0 -port 8080 -config api.disablekey=true

    - name: Wait for ZAP to be ready
      run: |
        echo "Waiting for ZAP..."
        for i in {1..90}; do
          if curl -s http://localhost:8080/JSON/core/view/version/ >/dev/null; then
            echo "ZAP is ready!"
            break
          fi
          echo "Still starting... ($i/90)"
          sleep 2
        done

    - name: Run ZAP API Scan
      run: |
        docker exec zap python3 /zap/zap-api-scan.py \
          -t "https://demo.testfire.net/swagger/properties.json" \
          -f openapi \
          -r zap_report.html \
          -J zap_report.json \
          -m 60

    - name: Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: zap-reports
        path: |
          zap_report.html
          zap_report.json

    - name: Cleanup
      run: docker rm -f zap || true
